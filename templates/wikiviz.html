{% extends "bootstrap/base.html" %}
{% block styles %}
	{{ super()}}
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
{% endblock %}

{% block scripts %}
{{super()}}

<script lang="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.js"></script>
<script lang="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>

<style>
.links line {
  stroke: #555;
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #000;
  stroke-width: 1.5px;
}

</style>

<script>

	$(document).ready(function(){
    $("#article").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "http://en.wikipedia.org/w/api.php",
                dataType: "jsonp",
                data: {
                    'action': "opensearch",
                    'format': "json",
                    'search': request.term
                },
                success: function(data) {
                    response(data[1]);
                }
            });
        }
    });

    });

    var num_core_nodes = 0;

    var master_nodes = [];
    var master_links = [];

    function get_weight(v) {
        return Math.log(v);
    }

    function node_num_algo(n) {
        return 20 + (5 * (n - 1));
    }

    var raw_results_to = '{{ results_to |tojson}}'
    var raw_results_from = '{{ results_from |tojson}}'
    var starticle = '{{article}}'

    var results_to = JSON.parse(raw_results_to);
    var results_from = JSON.parse(raw_results_from);

    var url = location.origin

    function closure(i, callback) {
        return function(n) {
            return callback(i, n);
        }
    }

    function get_set_from_nodes(array) {
        var outarr = array.filter((v,i,a) => a.findIndex(x => x.title == v.title) == i);
        return outarr
    }

    function get_set_from_links(array) {
        return array.filter((v,i,a) => a.findIndex(x => (x.source.id || x.source) == (v.source.id || v.source) && (x.target.id || x.target) == (v.target.id || v.target)) == i);
    }

    function add_new_article(innodes, inlinks, article, nnum, callback) {
        var promises = [new $.Deferred(), new $.Deferred()];
        var results = [];
        get_article_data(article, results, promises[0], promises[1]);

        var new_article_node = {"title": article, "group": 1, "weight": 0};

        $.when.apply($, promises).done(function () {
            var ngraph = generate_article_graph_data(article, results, [new_article_node], nnum, true);

            var new_nodes = ngraph[0];

            var new_links = ngraph[1];

            var lpromises = [];
            var lresults = [];
            for (var i = 0; i < new_nodes.length; i++) {
                lpromises.push(new $.Deferred());
                lpromises.push(new $.Deferred());
                get_article_data(new_nodes[i].title, lresults, lpromises[2*i], lpromises[(2*i)+1]);
            }

            $.when.apply($, lpromises).done(function () {
                var lgraph = generate_article_graph_data(article, lresults, new_nodes.concat(innodes.filter(x => x.group != 1)), 0, false);

                var links = new_links.concat(lgraph[1]).concat(inlinks);
                var nodes = new_nodes.concat(innodes);

                var og_node = nodes.findIndex(x => x.title == article);

                if (og_node == -1) {
                    nodes.push(new_article_node);
                } else {
                    nodes[og_node].group = 1;
                }

                console.log("RESULTS")
                console.log(nodes)
                console.log(links)

                callback(nodes, get_set_from_links(links))

            });
        });

        function get_internal_links(jsondata, nodes, name, is_to) {
            var nlinks = []
            for (var j = 0; j < jsondata.length; j++) {
                var index = nodes.findIndex(x => x.title == jsondata[j].name)
                if (index != -1) {
                    nlinks.push({"source": (is_to) ? name : jsondata[j].name, "target": (is_to) ? jsondata[j].name : name, "value": get_weight(jsondata[j].num_refs)});
                }
            }
            return nlinks
        }

        function generate_article_graph_data(article, data, nodes, nnum, should_nodes) {
            var nnodes = [];
            var nlinks = [];
            if (should_nodes) {
                for (var j = 0; j < data.length; j++) {
                    nnodes = nnodes.concat(
                        data[j].result.map(x => ({"title": x.name, "group": 0, "weight": x.num_refs}))
                    );
                }
            }

            nnodes = get_set_from_nodes(nnodes);

            nnodes = nnodes.sort((a,b) => b.weight - a.weight).slice(0, nnum)

            for (var i = 0; i < data.length; i++) {
                nlinks = nlinks.concat(get_internal_links(data[i].result, nnodes.concat(nodes), data[i].name, data[i].is_to));
            }
            return [nnodes, get_set_from_links(nlinks)];
        }

        function get_article_data(article, results, promise_to, promise_from) {
            $.ajax({
                "url": url + "/api/clickstream/to/" + article,
                "success": function(n) {
                    results.push({"result": n, "is_to": true, "name": article});
                    promise_to.resolve();
                }
            });
            $.ajax({
                "url": url + "/api/clickstream/from/" + article,
                "success": function(n) {
                    results.push({"result": n, "is_to": false, "name": article});
                    promise_from.resolve();
                }
            });
        }
    }

    function xor(a, b) {
        return (a || b) && !(a && b);
    }

/*
    function trim_graph(mnodes, mlinks, ncn) {

        var safe_nodes = mnodes.filter(x => x.group == 1);
        var risk_nodes = mnodes.filter(x => x.group != 1);

        var safe_links = mlinks.filter(x => mnodes.find(y => y.title == (x.source.title || x.source)).group == 1 && mnodes.find(y => y.title == (x.target.title || x.target)).group == 1);
        var risk_links = mlinks.filter(x => xor(mnodes.find(y => y.title == (x.source.title || x.source)).group == 1, mnodes.find(y => y.title == (x.target.title || x.target)).group == 1));
        var intr_links = mlinks.filter(x => mnodes.find(y => y.title == (x.source.title || x.source)).group != 1 && mnodes.find(y => y.title == (x.target.title || x.target)).group != 1);

        var top_risk_links = risk_links.sort((a,b) => b.value - a.value).slice(0, ncn);

        var top_risk_nodes = top_risk_links.map(x => (safe_nodes.findIndex(y => y.title == (x.source.title || x.source)) == -1) ? risk_nodes.find(z => z.title == (x.source.title || x.source))
                                                                                                                          : risk_nodes.find(z => z.title == (x.target.title || x.target)));

        var valid_intr_links = intr_links.filter(x => top_risk_nodes.findIndex(y => y.title == (x.source.title || x.source)) != -1 &&
                                                      top_risk_nodes.findIndex(y => y.title == (x.target.title || x.target)) != -1);
        var top_intr_links = valid_intr_links.sort((a,b) => b.value - a.value).slice(0, ncn);

        return [get_set_from_nodes(safe_nodes.concat(top_risk_nodes)), get_set_from_links(safe_links.concat(top_risk_links).concat(top_intr_links))];
    }
*/

    function get_source(weird) {
        return weird.source.title || weird.source;
    }

    function get_target(weird) {
        return weird.target.title || weird.target;
    }

    function trim_graph(mnodes, mlinks, ncn) {
        var safe_nodes = mnodes.filter(x => x.group == 1);
        var risk_nodes = mnodes.filter(x => safe_nodes.findIndex(y => y.title == x.title) == -1);

        var safe_links = mlinks.filter(x => mnodes.find(y => y.title == get_source(x)).group == 1 && mnodes.find(y => y.title == get_target(x)).group == 1);
        var risk_links = mlinks.filter(x => xor(mnodes.find(y => y.title == get_source(x)).group == 1, mnodes.find(y => y.title == get_target(x)).group == 1));
        var intr_links = mlinks.filter(x => !(mnodes.find(y => y.title == get_source(x)).group == 1 || mnodes.find(y => y.title == get_target(x)).group == 1));

        var top_risk_links = risk_links.sort((a,b) => b.value - a.value).slice(0, ncn);
        var top_risk_nodes = risk_nodes.filter(x => top_risk_links.findIndex(y => x.title == get_source(y)) != -1 || top_risk_links.findIndex(y => x.title == get_target(y)) != -1);

        var valid_intr_links = intr_links.filter(x => top_risk_nodes.findIndex(y => y.title == get_source(x)) != -1 && top_risk_nodes.findIndex(y => y.title == get_target(x)) != -1);

        var top_intr_links = valid_intr_links.sort((a,b) => b.value - a.value).slice(0, ncn);

        return [safe_nodes.concat(top_risk_nodes), safe_links.concat(top_risk_links).concat(top_intr_links)];
    }

    var margin = {top: 20, right: 20, bottom: 20, left: 10},
	      width = window.innerWidth - margin.left - margin.right,
	      height = window.innerHeight - margin.top - margin.bottom;

	var svg = d3.select("#chart").append("svg")
        .attr("width", width)
        .attr("height", height);

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    var is_context_menu_showing = false;

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function(d) { return d.title; }))
        .force("charge", d3.forceManyBody())
        .force("center", d3.forceCenter(width / 2, height / 2))
        .on("tick", ticked);

    simulation.force("charge").strength(-1 * Math.min(width, height))

    var link = svg.append("g")
        .attr("class", "links")
        .selectAll(".link")

    var node = svg.append("g")
        .attr("class", "nodes")
        .selectAll(".node");

    num_core_nodes += 1;
    add_new_article(master_nodes, master_links, starticle, node_num_algo(num_core_nodes), finish_doing_stuff);
    var mygraph = {"nodes": [], "links": []};

    function finish_doing_stuff(ooga_nodes, booga_links)
    {
        console.log(ooga_nodes)

        var trimmed = trim_graph(ooga_nodes, booga_links, node_num_algo(num_core_nodes));

        mygraph.nodes = trimmed[0];
        mygraph.links = trimmed[1];
       
        restart(mygraph.nodes, mygraph.links);
    }

    function restart(nodes, links) {

        d3.selectAll(".fnode").remove();
        d3.selectAll(".flink").remove();

        console.log(nodes)
        nodes.forEach(function(v) { delete v.x; delete v.y; });

        console.log(node)
        console.log(link)

        node = node.exit().remove();
        node = node.data(nodes).enter().append("g")
            .on('contextmenu', function(d, i ) {
                d3.event.preventDefault();
                num_core_nodes += 1;
                add_new_article(nodes, links, d.title, node_num_algo(num_core_nodes), finish_doing_stuff);
            })
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .attr("class", "fnode");

        node.append("circle")
          .attr("r", 15)
          .attr("fill", function(d) {return color(d.group)} );

        node.append("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(function(d) { return d.title.replace(/_/g, ' ') });

        link = link.exit().remove();
        link = link.data(links).enter().append("line")
            .attr("stroke-width", function(d) { return (d.value); })
            .attr("class", "flink");

        simulation
            .nodes(nodes)
        simulation.force("link")
            .links(links);

        simulation.alpha(1).restart();
    }

    function ticked() {
        link
            .attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

/*        node
            .attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });
*/
        node
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
      }

        function dragstarted(d) {
          if (!d3.event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }

        function dragged(d) {
          d.fx = d3.event.x;
          d.fy = d3.event.y;
        }

        function dragended(d) {
          if (!d3.event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }


	</script>
{% endblock %}

{% block content %}

<h1 id="title1">Wikipedia Clicks & Hierarchies</h1>
	<div class="btn-group btn-group-toggle" data-toggle="buttons">
  		<label class="btn btn-secondary active" id="option_click">
    		<input type="radio" name="options" id="option1" autocomplete="off" checked> Clickstream
  		</label>
  		<label class="btn btn-secondary" id="option_hier">
    		<input type="radio" name="options" id="option2" autocomplete="off"> Hierarchy
  		</label>
	</div>


		<form action="/wikiviz" method="post">
			<div class="form-group1">
            	{{ form.csrf }}

				<!-- <div type="search" placeholder="search another page" class="form-control" id="wikipage"> -->
					{{ form.article }}
				<!-- </div> -->
				<button type="submit" class="btn btn-default">Search</button>
			</div>
		</form>
    <div id="chart"></div>

{% endblock %}
