{% extends "bootstrap/base.html" %}
{% block styles %}
	{{ super()}}
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
{% endblock %}

{% block scripts %}
{{super()}}

<script lang="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.js"></script>
<script lang="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>

<style>
.links line {
  stroke: #555;
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #000;
  stroke-width: 1.5px;
}

</style>

<script>

	$(document).ready(function(){
    $("#article").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "http://en.wikipedia.org/w/api.php",
                dataType: "jsonp",
                data: {
                    'action': "opensearch",
                    'format': "json",
                    'search': request.term
                },
                success: function(data) {
                    response(data[1]);
                }
            });
        }
    });

    });

    var testdata_from = [
  {
    "name": "JavaScript",
    "num_refs": 50
  },
  {
    "name": "D3:_The_Mighty_Ducks",
    "num_refs": 18
  },
  {
    "name": "R_(programming_language)",
    "num_refs": 72
  },
  {
    "name": "OpenStreetMap",
    "num_refs": 32
  },
  {
    "name": "Prefuse",
    "num_refs": 14
  },
  {
    "name": "HTML5",
    "num_refs": 23
  },
  {
    "name": "Bates_distribution",
    "num_refs": 14
  },
  {
    "name": "Mike_Bostock",
    "num_refs": 197
  },
  {
    "name": "AnyChart",
    "num_refs": 127
  },
  {
    "name": "JSON",
    "num_refs": 21
  },
  {
    "name": "Data_visualization",
    "num_refs": 104
  },
  {
    "name": "JavaScript_library",
    "num_refs": 19
  },
  {
    "name": "SAS_(software)",
    "num_refs": 33
  },
  {
    "name": "Tableau_Software",
    "num_refs": 96
  },
  {
    "name": "Plotly",
    "num_refs": 86
  },
  {
    "name": "MATLAB",
    "num_refs": 50
  },
  {
    "name": "Main_Page",
    "num_refs": 20
  },
  {
    "name": "Qlik",
    "num_refs": 65
  },
  {
    "name": "Rapha\u00ebl_(JavaScript_library)",
    "num_refs": 69
  },
  {
    "name": "Cascading_Style_Sheets",
    "num_refs": 14
  },
  {
    "name": "Zoomdata",
    "num_refs": 48
  },
  {
    "name": "Protovis_himalayensis",
    "num_refs": 15
  },
  {
    "name": "Gnuplot",
    "num_refs": 50
  },
  {
    "name": "Matplotlib",
    "num_refs": 57
  },
  {
    "name": "Datacopia",
    "num_refs": 50
  },
  {
    "name": "Jeffrey_Heer",
    "num_refs": 81
  },
  {
    "name": "Document_Object_Model",
    "num_refs": 11
  },
  {
    "name": "Scalable_Vector_Graphics",
    "num_refs": 188
  },
  {
    "name": "Software_release_life_cycle",
    "num_refs": 15
  },
  {
    "name": "Processing_(programming_language)",
    "num_refs": 39
  },
  {
    "name": "Web_mapping",
    "num_refs": 11
  },
  {
    "name": "BSD_licenses",
    "num_refs": 158
  },
  {
    "name": "GeoJSON",
    "num_refs": 49
  }
]

    var testdata_to = [
  {
    "name": "Datadog",
    "num_refs": 12
  },
  {
    "name": "List_of_information_graphics_software",
    "num_refs": 51
  },
  {
    "name": "TypeScript",
    "num_refs": 126
  },
  {
    "name": "Comparison_of_JavaScript_charting_frameworks",
    "num_refs": 115
  },
  {
    "name": "Processing.js",
    "num_refs": 47
  },
  {
    "name": "OpenStreetMap",
    "num_refs": 19
  },
  {
    "name": "List_of_JavaScript_libraries",
    "num_refs": 262
  },
  {
    "name": "Mike_Bostock",
    "num_refs": 29
  },
  {
    "name": "Main_Page",
    "num_refs": 17
  },
  {
    "name": "Plotly",
    "num_refs": 23
  },
  {
    "name": "Business_intelligence_software",
    "num_refs": 79
  },
  {
    "name": "Data_visualization",
    "num_refs": 14
  },
  {
    "name": "List_of_charting_software",
    "num_refs": 11
  },
  {
    "name": "D3",
    "num_refs": 123
  },
  {
    "name": "List_of_reporting_software",
    "num_refs": 244
  },
  {
    "name": "SVG_animation",
    "num_refs": 24
  }
]
    function get_weight(v) {
        return Math.log(v);
    }
    var raw_results_to = '{{ results_to |tojson}}'
    var raw_results_from = '{{ results_from |tojson}}'
    var starticle = '{{article}}'

    var results_to = JSON.parse(raw_results_to);
    var results_from = JSON.parse(raw_results_from);

    var master_nodes = results_to.map(x => ({"id": x.name, "group": 0, "weight": get_weight(x.num_refs)}))
        .concat(results_from.map(x => ({"id": x.name, "group": 2, "weight": get_weight(x.num_refs)})))
        .filter((v,i,a) => a.indexOf(v).id === i.id)
        .sort((a,b) => b.weight - a.weight)
        .slice(0, 20);

    var master_links = master_nodes.map(x => ({"source": (x.group == 0) ? x.id : starticle, "target": (x.group == 0) ? starticle : x.id, "value": x.weight}));

    //for (var i = 0; i < master_nodes.length; i++);

    master_nodes.push({"id": starticle, "group": 1})

    var mygraph = {};
    mygraph.nodes = master_nodes;
    mygraph.links = master_links;

    console.log(mygraph)

	var margin = {top: 20, right: 20, bottom: 20, left: 10},
	      width = window.innerWidth - margin.left - margin.right,
	      height = window.innerHeight - margin.top - margin.bottom;

	var svg = d3.select("#chart").append("svg")
        .attr("width", width)
        .attr("height", height);

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function(d) { return d.id; }))
        .force("charge", d3.forceManyBody())
        .force("center", d3.forceCenter(width / 2, height / 2));

  var link = svg.append("g")
      .attr("class", "links")
    .selectAll("line")
    .data(mygraph.links)
    .enter().append("line")
      .attr("stroke-width", function(d) { return (d.value); });

  var node = svg.append("g")
      .attr("class", "nodes")
    .selectAll("circle")
    .data(mygraph.nodes)
    .enter().append("circle")
      .attr("r", 5)
      .attr("fill", function(d) {return color(d.group)} )
      .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

  node.append("title")
      .text(function(d) { return d.id; });

  simulation
      .nodes(mygraph.nodes)
      .on("tick", ticked);

  simulation.force("link")
      .links(mygraph.links);

  function ticked() {
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  }

    function dragstarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

	</script>
{% endblock %}

{% block content %}

<h1 id="title1">Wikipedia Clicks & Hierarchies</h1>
	<div class="btn-group btn-group-toggle" data-toggle="buttons">
  		<label class="btn btn-secondary active" id="option_click">
    		<input type="radio" name="options" id="option1" autocomplete="off" checked> Clickstream
  		</label>
  		<label class="btn btn-secondary" id="option_hier">
    		<input type="radio" name="options" id="option2" autocomplete="off"> Hierarchy
  		</label>
	</div>


		<form action="/wikiviz" method="post">
			<div class="form-group1">
            	{{ form.csrf }}

				<!-- <div type="search" placeholder="search another page" class="form-control" id="wikipage"> -->
					{{ form.article }}
				<!-- </div> -->
				<button type="submit" class="btn btn-default">Search</button>
			</div>
		</form>
    <div id="chart"></div>

{% endblock %}
