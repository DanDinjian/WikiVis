{% extends "bootstrap/base.html" %}
{% block styles %}
	{{ super()}}
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
{% endblock %}

{% block scripts %}
{{super()}}
<script lang="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
<script lang="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>

<script> 

	$(document).ready(function(){
    $("#article").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "http://en.wikipedia.org/w/api.php",
                dataType: "jsonp",
                data: {
                    'action': "opensearch",
                    'format': "json",
                    'search': request.term
                },
                success: function(data) {
                    response(data[1]);
                }
            });
        }
    });

    });


	var margin = {top: 20, right: 20, bottom: 20, left: 10},
	      width = 900 - margin.left - margin.right,
	      halfWidth = width / 2,
	      height = 300 - margin.top - margin.bottom,
	      i = 0,
	      duration = 500,
	      root;

	$("#option13").on("click", function() {
	$("#svgclick").empty();
	});

	$("#option12").on("click", function() {
		console.log("YEAA")
	var getChildren = function(d){
	    var a = [];
	    if(d.winners) for(var i = 0; i < d.winners.length; i++){
	      d.winners[i].isRight = false;
	      d.winners[i].parent = d;
	      a.push(d.winners[i]);
	    }
	    if(d.challengers) for(var i = 0; i < d.challengers.length; i++){
	      d.challengers[i].isRight = true;
	      d.challengers[i].parent = d;
	      a.push(d.challengers[i]);
	    }
	    return a.length?a:null;
	  }
	  ;
	var tree = d3.layout.tree().size([height, width]);
	var diagonal = d3.svg.diagonal().projection(function(d) { return [d.y, d.x]; });
	var elbow = function (d, i) {
	if (d.source == d.target) return;
	diagonal = d3.svg.diagonal().projection(function(d) { 
	  return [d.y, d.x]; 
	});
	if (!d.target.isRight) {
	  var o = {
	    x: d.target.x0,
	    y: d.target.y0
	  };
	  d = {
	    source: calcLeft(d.source),
	    target: o
	  };
	  return diagonal(d, i);
	}
	return diagonal(d, i);
	};
	var connector = elbow;
	var calcLeft = function(d){
	var l = d.y;
	if(!d.isRight){
	  l = d.y-halfWidth;
	  l = halfWidth - l;
	}
	return {x : d.x, y : l};
	};
	var vis = d3.select("#chart").append("svg")
	  .attr("width", width + margin.right + margin.left)
	  .attr("height", height + margin.top + margin.bottom)
	  .attr("id", "svgclick")
	.append("g")
	  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	console.log("height is" + height);

	// var jsonData = {}
	// jsonData['name'] = "Life"

	var jsonData1 = '{{ results1 |tojson}}'
	console.log(jsonData1)
    var t = JSON.parse(jsonData1)
	 var jsonData2 = '{{ results2 |tojson }}'
	 console.log(jsonData2)

    var t2 = JSON.parse(jsonData2)

    data = {}
    data['name'] = '{{ article }}'
    data['winners'] = t
    data['challengers'] = t2
    console.log(data)

	var toArray = function(item, arr){
	arr = arr || [];
	var i = 0, l = item.children?item.children.length:0;
	arr.push(item);
	for(; i < l; i++){
	  toArray(item.children[i], arr);
	}
	return arr;
	};

       jsonData = {
        "name": "Overall Winner",
        "winners": [
          {
            "name": "Winner Left 1"
          },
          {"name": "Winner Left 2"},
          {"name": "Winner Left 3"}
        ],
        "challengers": [
          {
            "name": "Challenger Right 1",
            "challengers": [
              {"name": "Challenger Right 3"},
              {"name": "Challenger Right 4"},
              {"name": "Challenger Right 5"}

            ]
          },
          {
            "name": "Challenger Right 2",
            "challengers": [
              {
                "name": "Challenger Right 6"
              },
              {"name": "Challenger Right 7"},
              {"name": "Challenger Right 8"}

            ]
          }
        ]
      }
      console.log("ORIG IS: " + jsonData)
	//d3.json(jsonData, function(json) {
	//jsonto(jsonData)
	//function jsonto(json){
	root = data;
	root.x0 = height / 2;
	root.y0 = width / 2;
	var t1 = d3.layout.tree().size([height, halfWidth]).children(function(d){return d.winners;}),
	    t2 = d3.layout.tree().size([height, halfWidth]).children(function(d){return d.challengers;});
	t1.nodes(root);
	t2.nodes(root);

	var rebuildChildren = function(node){
	  node.children = getChildren(node);
	  if(node.children) node.children.forEach(rebuildChildren);
	}
	rebuildChildren(root);
	root.isLeft = false;
	update(root);
	//};

	function update(source) {
	// Compute the new tree layout.
	var nodes = toArray(source);
	console.log("NODES IS:" + nodes)
	// Normalize for fixed-depth.
	nodes.forEach(function(d) { d.y = d.depth * 180 + halfWidth; });
	// Update the nodesâ€¦
	var node = vis.selectAll("g.node")
	    .data(nodes, function(d) { return d.id || (d.id = ++i); });
	// Enter any new nodes at the parent's previous position.
	var nodeEnter = node.enter().append("g")
	    .attr("class", "node")
	    .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
	    .on("click", click);
	nodeEnter.append("circle")
	    .attr("r", 1e-6)
	    .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });
	nodeEnter.append("text")
	    .attr("dy", function(d) { return d.isRight?14:-8;})
	    .attr("text-anchor", "middle")
	    .text(function(d) { return d.name; })
	    .style("fill-opacity", 1e-6);
	// Transition nodes to their new position.
	var nodeUpdate = node.transition()
	    .duration(duration)
	    .attr("transform", function(d) { p = calcLeft(d); return "translate(" + p.y + "," + p.x + ")"; })
	    ;
	nodeUpdate.select("circle")
	    .attr("r", 4.5)
	    .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });
	nodeUpdate.select("text")
	    .style("fill-opacity", 1);
	// Transition exiting nodes to the parent's new position.
	var nodeExit = node.exit().transition()
	    .duration(duration)
	    .attr("transform", function(d) { p = calcLeft(d.parent||source); return "translate(" + p.y + "," + p.x + ")"; })
	    .remove();
	nodeExit.select("circle")
	    .attr("r", 1e-6);
	nodeExit.select("text")
	    .style("fill-opacity", 1e-6);
	// Update the links...
	var link = vis.selectAll("path.link")
	  .data(tree.links(nodes), function(d) { return d.target.id; });
	 
	// Enter any new links at the parent's previous position.
	link.enter().insert("path", "g")
	  .attr("class", "link")
	  .attr("d", function(d) {
	    var o = {x: source.x0, y: source.y0};
	    return connector({source: o, target: o});
	  });
	// Transition links to their new position.
	link.transition()
	  .duration(duration)
	  .attr("d", connector); /**/
	// Transition exiting nodes to the parent's new position.
	link.exit().transition()
	  .duration(duration)
	  .attr("d", function(d) {
	    var o = calcLeft(d.source||source);
	    if(d.source.isRight) o.y -= halfWidth - (d.target.y - d.source.y);
	    else o.y += halfWidth - (d.target.y - d.source.y);
	    return connector({source: o, target: o});
	  })
	  .remove();
	// Stash the old positions for transition.
	nodes.forEach(function(d) {
	var p = calcLeft(d);
	d.x0 = p.x;
	d.y0 = p.y;
	});

	// Toggle children on click.
	function click(d) {
	if (d.children) {
	  d._children = d.children;
	  d.children = null;
	} else {
	  d.children = d._children;
	  d._children = null;
	}
	update(source);
		}
	}
	});
	</script>
{% endblock %}

{% block content %}
		
<h1 id="title1">Wikipedia Clicks & Hierarchies</h1>
	<div class="btn-group btn-group-toggle" data-toggle="buttons">
  		<label class="btn btn-secondary active" id="option12">
    		<input type="radio" name="options" id="option1" autocomplete="off" checked> Clickstream
  		</label>
  		<label class="btn btn-secondary" id="option13">
    		<input type="radio" name="options" id="option2" autocomplete="off"> Hierarchy
  		</label>
	</div>


		<form action="/wikiviz" method="post">
			<div class="form-group1">
            	{{ form.csrf }}

				<!-- <div type="search" placeholder="search another page" class="form-control" id="wikipage"> -->
					{{ form.article }}
				<!-- </div> -->
				<button type="submit" class="btn btn-default">Search</button>
			</div>
		</form>    
    <div id="chart"></div>

{% endblock %}